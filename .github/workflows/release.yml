name: Publish dev release

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RELEASE_TAG: dev

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: "22.x"
          registry-url: "https://npm.pkg.github.com"

      - name: Install dependencies
        run: yarn install

      - name: Run ESLint
        run: yarn run lint

      - name: Build packages
        env:
          OF_DEMO_ROOT_PATH: "/oceanfront/"
        run: yarn run build

      - name: Create packages
        env:
          OF_DEMO_ROOT_PATH: "/oceanfront/"
        run: yarn run package

      - name: Run unit tests
        run: yarn run test

      - name: Upload oceanfront package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "./packages/oceanfront/oceanfront-v0.1.0.tgz"
          asset_name: oceanfront.tgz
          tag: ${{ env.RELEASE_TAG }}
          overwrite: true

      - name: Upload of-colorscheme-editor package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "./packages/of-colorscheme-editor/of-colorscheme-editor-v0.1.0.tgz"
          asset_name: of-colorscheme-editor.tgz
          tag: ${{ env.RELEASE_TAG }}
          overwrite: true

      - name: Upload oceanfront-html-editor package
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "./packages/oceanfront-html-editor/oceanfront-html-editor-v0.1.0.tgz"
          asset_name: oceanfront-html-editor.tgz
          tag: ${{ env.RELEASE_TAG }}
          overwrite: true

      - name: Checkout app-js repository
        uses: actions/checkout@v3
        with:
          repository: 1CRM/app-js
          ref: main
          token: ${{ secrets.APPJS_PING_TOKEN }}
          path: app-js

      - name: Copy oceanfront build
        run: |
          mkdir -p app-js/packages/app-js/src/oceanfront/dist
          mkdir -p app-js/packages/1crm-app-js-lib/src/oceanfront
          cp -r packages/oceanfront/dist/* app-js/packages/app-js/src/oceanfront/dist/
          cp packages/oceanfront/package.json app-js/packages/app-js/src/oceanfront/package.json
          cp packages/oceanfront/dist/index.d.ts app-js/packages/1crm-app-js-lib/src/oceanfront/index.d.ts

      - name: Copy of-colorscheme-editor build
        run: |
          mkdir -p app-js/packages/app-js/src/of-colorscheme-editor/dist
          cp -r packages/of-colorscheme-editor/dist/* app-js/packages/app-js/src/of-colorscheme-editor/dist/
          cp packages/of-colorscheme-editor/package.json app-js/packages/app-js/src/of-colorscheme-editor/package.json

      - name: Copy oceanfront-html-editor build
        run: |
          mkdir -p app-js/packages/app-js/src/oceanfront-html-editor/dist
          cp -r packages/oceanfront-html-editor/dist/* app-js/packages/app-js/src/oceanfront-html-editor/dist/
          cp packages/oceanfront-html-editor/package.json app-js/packages/app-js/src/oceanfront-html-editor/package.json

      - name: Check for changes and commit
        working-directory: app-js
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add packages/app-js/src/oceanfront packages/app-js/src/of-colorscheme-editor packages/app-js/src/oceanfront-html-editor packages/1crm-app-js-lib/src/oceanfront
            git commit -m "chore: update oceanfront build from ${{ github.sha }}"
            git push
            echo "Changes committed and pushed to main branch"
          else
            echo "No changes detected, skipping commit"
          fi
